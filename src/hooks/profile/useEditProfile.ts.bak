import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAppDispatch, useAppSelector } from '@/src/lib/redux/hooks';
import { setLoggedInUserDetails } from '@/src/lib/redux/authSlice';
import { useAlert } from '../common/useAlert';
import useUpdateProfileApi from '@/src/api/profile/useUpdateProfile';
import useUploadFile from '@/src/api/common/useUploadFile';

export type EditProfileFormState = {
	firstName: string;
	lastName: string;
	userName: string;
	bio: string;
	avatar: string;
};

const deriveInitialState = (user?: TCommonResponseData): EditProfileFormState => {
	return {
		firstName: user?.firstName ?? '',
		lastName: user?.lastName ?? '',
		userName: user?.userName ?? '',
		bio: user?.bio ?? '',
		avatar: user?.avatar ?? '',
	};
};

const useEditProfile = () => {
	const router = useRouter();
	const dispatch = useAppDispatch();
	const { success, error } = useAlert();
	const { loggedInUserDetails } = useAppSelector(state => state.auth);

	const [form, setForm] = useState<EditProfileFormState>(() =>
		deriveInitialState(loggedInUserDetails)
	);
	const [showSuccess, setShowSuccess] = useState(false);

	const handleChange = (field: keyof EditProfileFormState, value: string) => {
		setForm(prev => ({ ...prev, [field]: value }));
	};

	const onCompleted = (response: TAPIResponse<TCommonResponseData, 'updateUserProfile'>) => {
		const { success: ok, message, data } = response.updateUserProfile;

		if (!ok || !data) {
			error('Profile Update Failed', message ?? 'Something went wrong updating your profile.');
			return;
		}

		// Keep existing auth data (token etc.), update with latest user fields
		dispatch(
			setLoggedInUserDetails({
				...(loggedInUserDetails ?? {}),
				...data,
				isUserLoggedIn: true,
			})
		);

		success('Profile Updated', message ?? 'Your profile has been updated.');
		setShowSuccess(true);

		setTimeout(() => {
			setShowSuccess(false);
			router.back();
		}, 2000);
	};

	const { updateProfile, loading: updateLoading } = useUpdateProfileApi(onCompleted);

	const { uploadFile, loading: uploadLoading } = useUploadFile(
		(data) => {
			// REST response format: { statusCode, success, message, data: { url, fileName } }
			const url = data.data?.url;
			if (url) {
				setForm(prev => ({ ...prev, avatar: url }));
				success('Avatar Uploaded', 'Your profile picture has been updated. Don\'t forget to save.');
			}
		},
		(err) => {
			error('Upload Failed', err.message || 'Could not upload image.');
		}
	);

	const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
		const file = e.target.files?.[0];
		if (file) {
			uploadFile({ file, folder: 'avatars' });
		}
	};

	const handleSubmit = () => {
		if (!loggedInUserDetails) {
			error('Profile Update Failed', 'You need to be logged in to update your profile.');
			return;
		}

		updateProfile({
			firstName: form.firstName || loggedInUserDetails.firstName,
			lastName: form.lastName || loggedInUserDetails.lastName,
			userName: form.userName || loggedInUserDetails.userName || '',

			bio: form.bio,
			avatar: form.avatar,
		});
	};

	return {
		form,
		loading: updateLoading || uploadLoading,
		showSuccess,
		handleChange,
		handleSubmit,
		handleFileChange,
		goBack: () => router.back(),
	};
};

export default useEditProfile;

